\chapter{State of the Art}
\label{chapter:second}

Computer security mostly refers to the mechanisms that are used to protect computers and networks from different threats. Recent history is full of famous attacks on computers, networks and especially over the Internet. Although this field deals with many more security related issues, one of the major threats to computer security is malware.

\section{Computer security and threats}

Computer security is information security applied to computers and networks. This field covers the mechanisms by which computers and computer related equipment is protected from different types of threats, such as: attacks from crackers and malicious software. This field also covers protection methods from unplanned events and natural disasters.

Computer security is generally achieved by limiting resource access to users and programs such that each has only the privileges it needs to function properly.

Given the fact that the Internet was not initially designed with the intent of ensuring a secure channel of communication, most computer security issues are network related. Although security mechanisms have been implemented over the Internet, some are still vulerable to attacks.

In computer security, a threat refers to an action that has the potential to harm an information system by obtaining unauthorized access to the system, modifying data, revealing sensitive information or by performing a Denial-of-Service attack.

The basis of Information Security is the CIA triad: Confidentiality, Integrity and Availability.

Attacks are classified into active or passive attacks. An attack is considered \textit{active} when it attempts to alter system resources or affect their operation, therefore compromising the system's Integrity and Availability.
A \textit{passive} attack acquires information from the system but it does not affect its resources or operation, therefore compromising Confidentiality \cite{rfc2828}.

\section{Malware types}
\label{sec:mal-types}

Malware, or malicious software, is software programmed and used by attackers in order to gain access to private computers, to obtain sensitive information or to simply disrupt normal computer operation. Malware generically refers to a variety of program forms: viruses, worms, Trojan horses and spyware.

A virus is a program that attempts to replicate itself into other executable files by injecting or replacing code. When the infected programs are run, they can infect other ones in turn. They typically target common programs which are found on most machines and executables and copy themselves to key directories.

Worms are similar to viruses, only that they spread over the network to other hosts which have the same vulnerability as the initial host. This is done by performing network port scans, DNS queries and then trying to infect other machines. Also, this type of malware usually downloads a second program from a remote server.

Trojan horses, or Trojans, are non-self-replicating code that try to gain privileged access to an operating system and while they seem to be performing a legitimate action they deliver a malicious payload. The payload often contains a backdoor for the attacker that gives him access to the computer or a botnet to send spam or perform Denial-of-Service attacks.

Backdoors are an alternative method of authentification to a system which bypasses normal authentification and secures illegal remote acces. This type of malicious software is installed by attackers after they have compromised a system through an alternative method.

Rootkits are used by attackers to keep access to a compromised system and are designed to hide files and the existence of processes and network connections from detection methods. Rootkit instalation can done automatically or an attacker can install it after he has gained root or administrator access to the system.

A botnet is a network of ``zombie'' computers that have been compromised and are used to perform malicious actions like: Distributed Denial-of-Service attacks (or DDoS\abbrev{DDoS}{Distributed Denial of Service}). DDoS attacks are carried out in order to stop a machine or network resource from functioning efficiently or from functioning at all.

Adware, or advertising-supported software, is a term that refers both legitimate advertising software and malware. When used to refer malware, adware refers to programs that present unwanted advertisments to the user of a computer, sometimes under the form of pop-up windows.

Spyware is software created for gathering information without the user's consent. This kind of malware is usually installed without the knowledge of the user or by using deceptive tactics \cite{mal-behavior-analysis}.

\fig[scale=0.6]{src/img/malware-types.pdf}{img:malware-types}{Malware Types}

\labelindexref{Figure}{img:malware-types} shows a classification of malware types based on means of distribution and their dependency on host programs to propagate themselves.

\fig[scale=0.6]{src/img/mal-statistics-type.png}{img:mal-statistics-type}{Malware distribution by type}

In \labelindexref{Figure}{img:mal-statistics-type} we can see malware distribution by type. These statistics were produced by \textbf{Panda Security} for the 1\ts{st} quarter of 2013. 

%\labelindexref{Figure}{img:mal-statistics-infected} shows the procentage of malware infections by type. 
%\fig[scale=0.6]{src/img/mal-statistics-infected.png}{img:mal-statistics-infected}{Malware infections by type}

\section{Avoiding detection}
\label{sec:avoid-det}

Malware and anti-malware software evolution is tightly coupled: when detection methods become more efficient, malware writters use better hiding techniques. In response, anti-malware developers use better algorithms. In the course of time, the development of anti-malware software has led attackers to start using different obfuscation methods to avoid detection, such as: concealing API\abbrev{API}{Application Programming Interface}-calling behavior, polymorphic and metamorphic malware.

Malware writers obscure API-calling behavior by using indirect calls. In this respect, API calls can be achieved by using hard coded addresses but this method is incompatible with different versions of the operating system. Another method commonly employed is to define homonymy functions that first locate the API functions addresses and then use the stored address. Also, arrays can be used to store the API function name and the relocation address \cite{static-detection-behavior}.

Polymorphic viruses use a polymorphic engine to change its executable while keeping the original function intact. A common technique to ``morph'' viruses is to encrypt the malicious payload and decrypt it at runtime. The encrypted code will then apear to be meaningless and it will be ignored. To obfuscate the decryption routine, the code is transformed by inserting \textbf{nop} instructions, permuting register allocation, reordering instructions and inserting jump instructions to maintain the semantics.

Metamorphic viruses also use an engine to change their code in a variety of ways, such as code transposition and substituting instruction sequences with equivalent ones. In addition to this, they interweave their code with the original program's code to trick heuristic detection methods. An important difference between a metamorphic engine and a polymorphic one is that the first can rewrite itself while the second cannot \cite{testing-mal-det}.

\section{Malware detectors}
\label{sec:mal-detectors}

Malware detectors are developed by performing analysis on samples gathered through various means: honeypots, web crawlers, spam traps and security analysts that collect them from infected computers. Bayer \textit{et al.} \cite{current-mal-behavior} provided insight into common behavior by analyzing almost one million malware samples by monitoring their network activity and tracking data flows.

Bayer \textit{et al.} created a platform, named Anubis \cite{anubis-platform}, for the dynamic analysis of malware samples which targeted Windows operating systems. The behavior of malware samples was monitored for file system, registry, network and botnet activity, GUI windows and sandbox detection. Sandboxes are contained environments used to run and test malicious software. The statistics they presented offer insight into common malware behavior and give a hint to what the main goal of malware detectors should be.

Signature based malware detectors use a list of signatures (signature database or SB\abbrev{SB}{signature database}) to identify known viruses. The signatures are patterns of data withing executable code and they are generated after static and dynamic analysis by specialists. If a part of a program matches a signature entry from the list, then it is classified as malware. This detection method performes very poorly when confrunted with new samples because the signature is unknown. Also, malware writers can easily avoid detection from this type of detectors by using obfuscation techniques in their programs, like polymorphism or metamorphism \cite{mining-specifications}. 

Over time, the approach in detecting malware has evolved from analyzing the contents of infected executable files towards identifying malicious or potentially malicious behavior patterns. These patterns are extracted from the malware sample by static or dynamic analysis.

Static analysis of the executable involves scanning the file for particular instruction sequences or different API calls. In order to avoid detection from this type of analysis, attackers attempt to obscure their API-calling behavior or they use a polymorphic engine.

Another method for analysis is to monitor the behavior of the malicious program during runtime in a sandbox, otherwise known as dynamic analysis. This method monitors the malware's interraction with the operating system and the network traffic it produces in order to determine its behavior.

As pointed out in \cite{smartphone-malware-detection}, where a taxonomy of malware detectors for smartphones is presented, the signatures used by signature based detectors can be a simple hash/byte signature or a behavior signature. Behavior signatures can be generated from static analysis, containing information such as code syntax and structure, and from dynamic analysis, which consist of malicious behavior patterns that appear on runtime.

Semantics-aware malware detectors can overcome the problems posed by obfuscation by using specifications of malicious behavior which are not affected by polymorphic malware. By using a higher-level specification, different versions or implementations of malware which perform the same behavior can be detected. Another advantage of this type of detector is that it can also successfully classify unknown malware \cite{semantics-based-detection}.

\section{Malspec Mining Algorithm}
\label{sec:malspec-alg}

The problem with behavior-based detection is that the required specifications have to be manually identified by a malware specialist. The malspec mining algorithm developed by Christodorescu \textit{et al.} \cite{mining-specifications} provides a method for automating this otherwise time consuming task. \abbrev{malspec}{malware specification}

Their malspec mining algorithm starts by collecting execution traces from malware and benign programs, then it constructs the corresponding dependence graphs and then it computes the specification of malicious behavior as difference of dependence graphs as minimal contrast subgraph patterns \cite{minimal-contrast-subgraph}.

The malspec mining algorithm was implemented and tested on a Windows operating system and, although it identified a large number of malware specifications, it also managed to capture most of the specifications that were indicated by specialists \cite{mining-specifications}.

In this thesis we present an implementation of this algorithm for GNU/Linux based operating systems. In order to capture a program’s behavior we developed a system call interceptor and a network traffic interceptor as Linux kernel modules.

Then, a user space program reads the traces from the kernel module and constructs a graph where each node represents a system call and the edges represent parameter dependencies. The edges are determined by interpreting the parameter type, direction and value of the recorded system calls. Finally, the malspec mining algorithm will generate the malicious behavior specifications.
